<!DOCTYPE html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>è»½é‡ç‰ˆè‹±å˜èªå­¦ç¿’ã‚¢ãƒ—ãƒª</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: system-ui, -apple-system, sans-serif;
        background: #f5f5f5;
        padding: 20px;
        line-height: 1.6;
      }

      .container {
        max-width: 800px;
        margin: 0 auto;
        background: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        padding: 30px;
      }

      h1 {
        text-align: center;
        color: #333;
        margin-bottom: 30px;
      }

      .stats {
        display: flex;
        justify-content: space-around;
        margin-bottom: 30px;
        padding: 20px;
        background: #f8f9fa;
        border-radius: 5px;
      }

      .stat-item {
        text-align: center;
      }

      .stat-value {
        font-size: 2em;
        font-weight: bold;
        color: #007bff;
      }

      .controls {
        text-align: center;
        margin-bottom: 30px;
      }

      .btn {
        padding: 10px 20px;
        margin: 0 10px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        font-size: 16px;
        transition: opacity 0.2s;
      }

      .btn-primary {
        background: #007bff;
        color: white;
      }

      .btn-secondary {
        background: #6c757d;
        color: white;
      }

      .btn-success {
        background: #28a745;
        color: white;
      }

      .btn:hover {
        opacity: 0.8;
      }

      .btn.active {
        background: #0056b3;
      }

      .file-upload {
        margin-bottom: 30px;
        padding: 20px;
        border: 2px dashed #ccc;
        border-radius: 5px;
        text-align: center;
      }

      .loading-message {
        text-align: center;
        color: #666;
        font-style: italic;
        margin-bottom: 20px;
      }

      .word-card {
        text-align: center;
        padding: 30px;
        border: 1px solid #eee;
        border-radius: 5px;
        margin-bottom: 20px;
      }

      .word-display {
        font-size: 3em;
        font-weight: bold;
        color: #333;
        margin-bottom: 20px;
      }

      .word-info {
        font-size: 1.1em;
        color: #666;
        margin-bottom: 20px;
      }

      .meaning,
      .example {
        font-size: 1.2em;
        margin: 15px 0;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 5px;
      }

      .example {
        font-style: italic;
        color: #555;
      }

      .quiz-options {
        margin: 20px 0;
      }

      .quiz-option {
        display: block;
        width: 100%;
        padding: 15px;
        margin: 10px 0;
        border: 1px solid #ddd;
        border-radius: 5px;
        cursor: pointer;
        background: white;
        font-size: 16px;
      }

      .quiz-option:hover {
        background: #f8f9fa;
      }

      .quiz-option.selected {
        background: #e3f2fd;
        border-color: #007bff;
      }

      .quiz-option.correct {
        background: #d4edda;
        border-color: #28a745;
      }

      .quiz-option.incorrect {
        background: #f8d7da;
        border-color: #dc3545;
      }

      .progress {
        width: 100%;
        height: 20px;
        background: #e9ecef;
        border-radius: 10px;
        overflow: hidden;
        margin-bottom: 20px;
      }

      .progress-bar {
        height: 100%;
        background: #007bff;
        transition: width 0.3s;
      }

      .hidden {
        display: none;
      }

      /* å•é¡ŒçŠ¶æ…‹è¡¨ç¤ºã®ã‚¹ã‚¿ã‚¤ãƒ« */
      .word-list-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding: 0 10px;
      }

      .word-list-title {
        font-size: 1.2em;
        font-weight: bold;
        color: #333;
      }

      .filter-buttons {
        display: flex;
        gap: 5px;
      }

      .filter-btn {
        padding: 5px 10px;
        border: 1px solid #ddd;
        border-radius: 3px;
        background: white;
        cursor: pointer;
        font-size: 12px;
        transition: all 0.2s;
      }

      .filter-btn:hover {
        background: #f8f9fa;
      }

      .filter-btn.active {
        background: #007bff;
        color: white;
        border-color: #007bff;
      }

      .word-list {
        max-height: 400px;
        overflow-y: auto;
        border: 1px solid #eee;
        border-radius: 5px;
        padding: 10px;
        margin-top: 10px;
      }

      .word-item {
        padding: 12px;
        cursor: pointer;
        border-radius: 3px;
        margin-bottom: 5px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        border-left: 4px solid transparent;
      }

      .word-item:hover {
        background: #f8f9fa;
      }

      .word-item.active {
        background: #007bff;
        color: white;
        border-left-color: #0056b3;
      }

      .word-item.solved {
        background: #d4edda;
        border-left-color: #28a745;
      }

      .word-item.active.solved {
        background: #218838;
        color: white;
      }

      .word-item.incorrect {
        background: #f8d7da;
        border-left-color: #dc3545;
      }

      .word-item.active.incorrect {
        background: #c82333;
        color: white;
      }

      .word-info-left {
        flex: 1;
        text-align: left;
      }

      .word-status {
        font-size: 0.9em;
        padding: 2px 8px;
        border-radius: 12px;
        font-weight: bold;
        white-space: nowrap;
      }

      .status-unsolved {
        background: #e9ecef;
        color: #6c757d;
      }

      .status-correct {
        background: #28a745;
        color: white;
      }

      .status-incorrect {
        background: #dc3545;
        color: white;
      }

      .word-item.active .word-status {
        background: rgba(255, 255, 255, 0.3);
        color: white;
      }

      .legend {
        display: flex;
        justify-content: center;
        gap: 20px;
        margin-bottom: 15px;
        padding: 10px;
        background: #f8f9fa;
        border-radius: 5px;
        font-size: 0.9em;
      }

      .legend-item {
        display: flex;
        align-items: center;
        gap: 5px;
      }

      .legend-color {
        width: 12px;
        height: 12px;
        border-radius: 2px;
      }

      .legend-unsolved {
        background: #e9ecef;
      }
      .legend-correct {
        background: #28a745;
      }
      .legend-incorrect {
        background: #dc3545;
      }

      @media (max-width: 600px) {
        .stats {
          flex-direction: column;
          gap: 10px;
        }

        .btn {
          display: block;
          margin: 5px 0;
        }

        .word-list-header {
          flex-direction: column;
          gap: 10px;
        }

        .legend {
          flex-direction: column;
          gap: 5px;
        }
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>ğŸ“š è»½é‡ç‰ˆè‹±å˜èªå­¦ç¿’ã‚¢ãƒ—ãƒª</h1>

      <div class="file-upload">
        <p>
          CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ (Lemma, SFI Rank, SFI, Frequency, æ„å‘³,
          ä¾‹æ–‡)
        </p>
        <input type="file" id="csvFile" accept=".csv" />
        <div id="loadingMessage" class="loading-message hidden">
          gee.csvã‚’èª­ã¿è¾¼ã¿ä¸­...
        </div>
        <div style="margin-top: 10px; font-size: 0.9em; color: #666">
          ğŸ’¡
          <strong>ãƒ’ãƒ³ãƒˆ:</strong>
          gee.csvãŒè‡ªå‹•èª­ã¿è¾¼ã¿ã•ã‚Œãªã„å ´åˆã¯ã€ä¸Šè¨˜ã®ãƒ•ã‚¡ã‚¤ãƒ«é¸æŠæ©Ÿèƒ½ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚<br />
          <span id="localHint"
            >ã¾ãŸã¯ã€<code>python -m http.server 8000</code>
            ã§ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã‚’èµ·å‹•ã—ã¦
            <code>http://localhost:8000</code> ã§ã‚¢ã‚¯ã‚»ã‚¹ã—ã¦ãã ã•ã„ã€‚</span
          >
          <span id="githubHint" style="display: none"
            >GitHub Pagesã§ã¯é€šå¸¸è‡ªå‹•èª­ã¿è¾¼ã¿ãŒæ­£å¸¸ã«å‹•ä½œã—ã¾ã™ã€‚</span
          >
        </div>
      </div>

      <div class="stats">
        <div class="stat-item">
          <div class="stat-value" id="totalWords">0</div>
          <div>ç·å˜èªæ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="correctAnswers">0</div>
          <div>æ­£è§£æ•°</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="accuracy">0%</div>
          <div>æ­£ç­”ç‡</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="unsolvedCount">0</div>
          <div>æœªè§£ç­”</div>
        </div>
      </div>

      <div class="controls">
        <button class="btn btn-primary active" id="flashcardMode">
          ãƒ•ãƒ©ãƒƒã‚·ãƒ¥ã‚«ãƒ¼ãƒ‰
        </button>
        <button class="btn btn-secondary" id="quizMode">ã‚¯ã‚¤ã‚º</button>
        <button class="btn btn-success" id="showUnsolvedBtn">
          æœªè§£ç­”ã®å•é¡Œ
        </button>
        <button class="btn btn-secondary" id="shuffleBtn">
          ğŸ”€ ã‚·ãƒ£ãƒƒãƒ•ãƒ«
        </button>
        <button class="btn btn-secondary" id="resetProgressBtn">
          é€²æ—ãƒªã‚»ãƒƒãƒˆ
        </button>
      </div>

      <div class="progress">
        <div class="progress-bar" id="progressBar"></div>
      </div>

      <div class="word-card">
        <div id="flashcardContent">
          <div class="word-display" id="wordDisplay">èª­ã¿è¾¼ã¿ä¸­...</div>
          <div class="word-info" id="wordInfo">
            CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™
          </div>
          <div class="meaning hidden" id="meaningDisplay"></div>
          <div class="example hidden" id="exampleDisplay"></div>
          <div>
            <button class="btn btn-primary" id="showAnswerBtn">
              ç­”ãˆã‚’è¡¨ç¤º
            </button>
            <button class="btn btn-secondary" id="nextWordBtn">æ¬¡ã®å˜èª</button>
          </div>
        </div>

        <div id="quizContent" class="hidden">
          <div class="word-display" id="quizWord">èª­ã¿è¾¼ã¿ä¸­...</div>
          <div class="word-info" id="quizInfo">
            CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™
          </div>
          <div class="quiz-options" id="quizOptions"></div>
          <div>
            <button class="btn btn-primary" id="submitAnswerBtn">
              å›ç­”ã™ã‚‹
            </button>
            <button class="btn btn-secondary" id="nextQuizBtn">æ¬¡ã®å•é¡Œ</button>
          </div>
        </div>
      </div>

      <div class="word-list-header">
        <div class="word-list-title">å˜èªä¸€è¦§</div>
        <div class="filter-buttons">
          <button class="filter-btn active" data-filter="all">ã™ã¹ã¦</button>
          <button class="filter-btn" data-filter="unsolved">æœªè§£ç­”</button>
          <button class="filter-btn" data-filter="correct">æ­£è§£</button>
          <button class="filter-btn" data-filter="incorrect">ä¸æ­£è§£</button>
        </div>
      </div>

      <div class="legend">
        <div class="legend-item">
          <div class="legend-color legend-unsolved"></div>
          <span>æœªè§£ç­”</span>
        </div>
        <div class="legend-item">
          <div class="legend-color legend-correct"></div>
          <span>æ­£è§£</span>
        </div>
        <div class="legend-item">
          <div class="legend-color legend-incorrect"></div>
          <span>ä¸æ­£è§£</span>
        </div>
      </div>

      <div class="word-list" id="wordList"></div>
    </div>

    <script>
      // ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ã®çŠ¶æ…‹
      let state = {
        words: [],
        currentIndex: 0,
        mode: "flashcard",
        showAnswer: false,
        correctAnswers: 0,
        totalAnswers: 0,
        wordResults: new Map(), // å„å˜èªã®çµæœã‚’ä¿å­˜ (index -> 'correct'/'incorrect')
        selectedOption: null,
        isLoading: true,
        currentFilter: "all",
        shuffledIndices: [], // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã•ã‚ŒãŸã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹é…åˆ—
        isShuffled: false, // ã‚·ãƒ£ãƒƒãƒ•ãƒ«çŠ¶æ…‹ã‹ã©ã†ã‹
      };

      // ãƒ­ãƒ¼ã‚«ãƒ«ã‚¹ãƒˆãƒ¬ãƒ¼ã‚¸ã®ã‚­ãƒ¼
      const STORAGE_KEY = "vocab_app_state";

      // ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
      const sampleWords = [
        {
          lemma: "the",
          sfiRank: 1,
          sfi: 87.85,
          frequency: 60910,
          meaning: "(å®šå† è©) ç‰¹å®šã®ã‚‚ã®ã‚’æŒ‡ã™æ™‚ã«ä½¿ã†ã€‚",
          example: "The sun rises in the east.",
        },
        {
          lemma: "be",
          sfiRank: 2,
          sfi: 83.21,
          frequency: 45678,
          meaning: "(å‹•è©) ï½ã§ã‚ã‚‹ã€ï½ã«ã„ã‚‹",
          example: "She is a teacher.",
        },
        {
          lemma: "have",
          sfiRank: 3,
          sfi: 78.45,
          frequency: 38901,
          meaning: "(å‹•è©) æŒã£ã¦ã„ã‚‹ã€é£Ÿã¹ã‚‹",
          example: "I have a car.",
        },
        {
          lemma: "do",
          sfiRank: 4,
          sfi: 75.32,
          frequency: 34567,
          meaning: "(å‹•è©) ã™ã‚‹ã€è¡Œã†",
          example: "What do you do?",
        },
        {
          lemma: "say",
          sfiRank: 5,
          sfi: 71.89,
          frequency: 29876,
          meaning: "(å‹•è©) è¨€ã†ã€è¿°ã¹ã‚‹",
          example: "She says hello.",
        },
        {
          lemma: "get",
          sfiRank: 6,
          sfi: 68.76,
          frequency: 26543,
          meaning: "(å‹•è©) å¾—ã‚‹ã€æ‰‹ã«å…¥ã‚Œã‚‹",
          example: "I get up early.",
        },
        {
          lemma: "make",
          sfiRank: 7,
          sfi: 65.43,
          frequency: 23210,
          meaning: "(å‹•è©) ä½œã‚‹ã€è£½é€ ã™ã‚‹",
          example: "Let's make a cake.",
        },
        {
          lemma: "go",
          sfiRank: 8,
          sfi: 62.18,
          frequency: 20987,
          meaning: "(å‹•è©) è¡Œãã€é€²ã‚€",
          example: "I go to school.",
        },
      ];

      // åˆæœŸåŒ–
      function init() {
        setupEvents();
        loadSavedState();

        // ç’°å¢ƒã«å¿œã˜ã¦ãƒ’ãƒ³ãƒˆè¡¨ç¤ºã‚’åˆ‡ã‚Šæ›¿ãˆ
        const isGitHubPages =
          window.location.hostname.includes("github.io") ||
          window.location.hostname.includes("github.com");

        if (isGitHubPages) {
          document.getElementById("localHint").style.display = "none";
          document.getElementById("githubHint").style.display = "inline";
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†å¾Œã«CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’è‡ªå‹•èª­ã¿è¾¼ã¿
        loadCSVFile();
      }

      // ä¿å­˜ã•ã‚ŒãŸçŠ¶æ…‹ã‚’èª­ã¿è¾¼ã¿
      function loadSavedState() {
        try {
          const saved = localStorage.getItem(STORAGE_KEY);
          if (saved) {
            const savedState = JSON.parse(saved);

            // é€²æ—ãƒ‡ãƒ¼ã‚¿ã®ã¿å¾©å…ƒ
            state.currentIndex = savedState.currentIndex || 0;
            state.mode = savedState.mode || "flashcard";
            state.correctAnswers = savedState.correctAnswers || 0;
            state.totalAnswers = savedState.totalAnswers || 0;
            state.wordResults = new Map(savedState.wordResults || []);
            state.currentFilter = savedState.currentFilter || "all";
            state.isShuffled = savedState.isShuffled || false;
            state.shuffledIndices = savedState.shuffledIndices || [];

            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’å¾©å…ƒ
            if (state.isShuffled) {
              document.getElementById("shuffleBtn").textContent = "ğŸ”„ å…ƒã®é †åº";
              document.getElementById("shuffleBtn").style.background = "#28a745";
            }

            console.log("ä¿å­˜ã•ã‚ŒãŸé€²æ—ã‚’å¾©å…ƒã—ã¾ã—ãŸ");
          }
        } catch (error) {
          console.error("ä¿å­˜ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—:", error);
        }
      }

      // çŠ¶æ…‹ã‚’ä¿å­˜
      function saveState() {
        try {
          const stateToSave = {
            currentIndex: state.currentIndex,
            mode: state.mode,
            correctAnswers: state.correctAnswers,
            totalAnswers: state.totalAnswers,
            wordResults: Array.from(state.wordResults.entries()),
            currentFilter: state.currentFilter,
            isShuffled: state.isShuffled,
            shuffledIndices: state.shuffledIndices,
            timestamp: new Date().toISOString(),
          };

          localStorage.setItem(STORAGE_KEY, JSON.stringify(stateToSave));
        } catch (error) {
          console.error("çŠ¶æ…‹ã®ä¿å­˜ã«å¤±æ•—:", error);
        }
      }

      // gee.csvã‚’è‡ªå‹•èª­ã¿è¾¼ã¿
      async function loadCSVFile() {
        try {
          document.getElementById("loadingMessage").classList.remove("hidden");
          document.getElementById("loadingMessage").textContent =
            "gee.csvã‚’èª­ã¿è¾¼ã¿ä¸­...";
          document.getElementById("loadingMessage").style.color = "#007bff";

          let csvText = null;

          // GitHub Pagesã§ã¯fetchãŒæ­£å¸¸ã«å‹•ä½œã™ã‚‹ãŸã‚ã€ã¾ãšfetchã‚’è©¦è¡Œ
          try {
            const response = await fetch("gee.csv");
            if (response.ok) {
              csvText = await response.text();
              console.log("CSVèª­ã¿è¾¼ã¿å®Œäº†:", csvText.length, "ãƒã‚¤ãƒˆ");
            } else {
              throw new Error(
                `CSVãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•— (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${response.status})`
              );
            }
          } catch (fetchError) {
            console.log(
              "fetchãŒå¤±æ•—ã€XMLHttpRequestã‚’è©¦è¡Œ:",
              fetchError.message
            );

            // XMLHttpRequestã«ã‚ˆã‚‹ä»£æ›¿æ–¹æ³•ï¼ˆãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒç”¨ï¼‰
            try {
              csvText = await loadCSVWithXHR();
            } catch (xhrError) {
              console.error("XMLHttpRequestã‚‚å¤±æ•—:", xhrError.message);
              throw new Error("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ");
            }
          }

          if (!csvText) {
            throw new Error("CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸ");
          }

          const words = parseCSV(csvText);
          console.log("è§£æå®Œäº†:", words.length, "å€‹ã®å˜èª");

          if (words.length > 0) {
            state.words = words;
            state.isLoading = false;

            // ä¿å­˜ã•ã‚ŒãŸé€²æ—ã«åŸºã¥ã„ã¦è¡¨ç¤ºã‚’æ›´æ–°
            updateDisplay();
            updateStats();
            updateWordList();
            setFilter(state.currentFilter);

            document.getElementById(
              "loadingMessage"
            ).textContent = `âœ… gee.csvã‹ã‚‰${words.length}å€‹ã®å˜èªã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼`;
            document.getElementById("loadingMessage").style.color = "#28a745";

            setTimeout(() => {
              document.getElementById("loadingMessage").classList.add("hidden");
            }, 3000);
          } else {
            throw new Error("æœ‰åŠ¹ãªå˜èªãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“");
          }
        } catch (error) {
          console.error("CSVèª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:", error);

          // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨
          state.words = sampleWords;
          state.isLoading = false;

          // ä¿å­˜ã•ã‚ŒãŸé€²æ—ã«åŸºã¥ã„ã¦è¡¨ç¤ºã‚’æ›´æ–°
          updateDisplay();
          updateStats();
          updateWordList();
          setFilter(state.currentFilter);

          // GitHub Pagesã‹ãƒ­ãƒ¼ã‚«ãƒ«ç’°å¢ƒã‹ã‚’åˆ¤å®šã—ã¦ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’å¤‰æ›´
          const isGitHubPages = window.location.hostname.includes("github.io");
          const message = isGitHubPages
            ? `âš ï¸ gee.csvãƒ•ã‚¡ã‚¤ãƒ«ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“<br>
               <small style="color: #666;">
               ãƒªãƒã‚¸ãƒˆãƒªã«gee.csvãƒ•ã‚¡ã‚¤ãƒ«ãŒã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰ã•ã‚Œã¦ã„ã‚‹ã‹ç¢ºèªã—ã¦ãã ã•ã„ã€‚
               </small>`
            : `âš ï¸ gee.csvãŒè¦‹ã¤ã‹ã‚‰ãªã„ãŸã‚ã€ã‚µãƒ³ãƒ—ãƒ«ãƒ‡ãƒ¼ã‚¿ã‚’ä½¿ç”¨ã—ã¦ã„ã¾ã™<br>
               <small style="color: #666;">
               ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«ã®åˆ¶é™ã«ã‚ˆã‚Šèª­ã¿è¾¼ã‚ãªã„å ´åˆãŒã‚ã‚Šã¾ã™ã€‚<br>
               ãƒ•ã‚¡ã‚¤ãƒ«ã‚¢ãƒƒãƒ—ãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½ã‚’ä½¿ç”¨ã™ã‚‹ã‹ã€ãƒ­ãƒ¼ã‚«ãƒ«ã‚µãƒ¼ãƒãƒ¼ã§å®Ÿè¡Œã—ã¦ãã ã•ã„ã€‚
               </small>`;

          document.getElementById("loadingMessage").innerHTML = message;
          document.getElementById("loadingMessage").style.color = "#dc3545";

          setTimeout(() => {
            document.getElementById("loadingMessage").classList.add("hidden");
          }, 8000);
        }
      }

      // XMLHttpRequestã«ã‚ˆã‚‹CSVèª­ã¿è¾¼ã¿ï¼ˆä»£æ›¿æ–¹æ³•ï¼‰
      function loadCSVWithXHR() {
        return new Promise((resolve, reject) => {
          const xhr = new XMLHttpRequest();
          xhr.open("GET", "gee.csv", true);
          xhr.onreadystatechange = function () {
            if (xhr.readyState === 4) {
              if (xhr.status === 200) {
                console.log(
                  "XMLHttpRequestæˆåŠŸ: CSVèª­ã¿è¾¼ã¿å®Œäº†:",
                  xhr.responseText.length,
                  "ãƒã‚¤ãƒˆ"
                );
                resolve(xhr.responseText);
              } else {
                reject(
                  new Error(`XMLHttpRequestå¤±æ•— (ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹: ${xhr.status})`)
                );
              }
            }
          };
          xhr.onerror = function () {
            reject(
              new Error("XMLHttpRequestã§ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ")
            );
          };
          xhr.send();
        });
      }

      // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
      function setupEvents() {
        document.getElementById("flashcardMode").onclick = () =>
          switchMode("flashcard");
        document.getElementById("quizMode").onclick = () => switchMode("quiz");
        document.getElementById("showAnswerBtn").onclick = showAnswer;
        document.getElementById("nextWordBtn").onclick = nextWord;
        document.getElementById("submitAnswerBtn").onclick = submitAnswer;
        document.getElementById("nextQuizBtn").onclick = nextQuiz;
        document.getElementById("csvFile").onchange = handleFileUpload;
        document.getElementById("resetProgressBtn").onclick = resetProgress;
        document.getElementById("showUnsolvedBtn").onclick = showUnsolved;
        document.getElementById("shuffleBtn").onclick = shuffleWords;

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¤ãƒ™ãƒ³ãƒˆ
        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.onclick = () => setFilter(btn.dataset.filter);
        });
      }

      // æœªè§£ç­”ã®å•é¡Œã‚’è¡¨ç¤º
      function showUnsolved() {
        if (state.isLoading) return;

        const unsolvedIndices = [];
        for (let i = 0; i < state.words.length; i++) {
          if (!state.wordResults.has(i)) {
            unsolvedIndices.push(i);
          }
        }

        if (unsolvedIndices.length === 0) {
          alert("ã™ã¹ã¦ã®å•é¡ŒãŒè§£ç­”æ¸ˆã¿ã§ã™ï¼");
          return;
        }

        // æœ€åˆã®æœªè§£ç­”å•é¡Œã«ç§»å‹•
        state.currentIndex = unsolvedIndices[0];
        state.showAnswer = false;
        state.selectedOption = null;

        // ã‚¯ã‚¤ã‚ºãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆ
        switchMode("quiz");

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã‚’æœªè§£ç­”ã«è¨­å®š
        setFilter("unsolved");

        alert(
          `${unsolvedIndices.length}å€‹ã®æœªè§£ç­”å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚æœ€åˆã®å•é¡Œã«ç§»å‹•ã—ã¾ã—ãŸã€‚`
        );
      }

      // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¨­å®š
      function setFilter(filter) {
        state.currentFilter = filter;

        // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ãƒœã‚¿ãƒ³ã®ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
        document.querySelectorAll(".filter-btn").forEach((btn) => {
          btn.classList.toggle("active", btn.dataset.filter === filter);
        });

        updateWordList();
        saveState();
      }

      // ã‚·ãƒ£ãƒƒãƒ•ãƒ«æ©Ÿèƒ½
      function shuffleWords() {
        if (state.isLoading || state.words.length === 0) return;

        if (state.isShuffled) {
          // ã‚·ãƒ£ãƒƒãƒ•ãƒ«è§£é™¤ï¼ˆå…ƒã®é †åºã«æˆ»ã™ï¼‰
          state.isShuffled = false;
          state.shuffledIndices = [];
          state.currentIndex = 0;
          
          document.getElementById("shuffleBtn").textContent = "ğŸ”€ ã‚·ãƒ£ãƒƒãƒ•ãƒ«";
          document.getElementById("shuffleBtn").style.background = "#6c757d";
          
          alert("å˜èªã®é †åºã‚’å…ƒã«æˆ»ã—ã¾ã—ãŸã€‚");
        } else {
          // ã‚·ãƒ£ãƒƒãƒ•ãƒ«å®Ÿè¡Œ
          state.shuffledIndices = Array.from({length: state.words.length}, (_, i) => i);
          
          // Fisher-Yates ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ 
          for (let i = state.shuffledIndices.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [state.shuffledIndices[i], state.shuffledIndices[j]] = 
            [state.shuffledIndices[j], state.shuffledIndices[i]];
          }
          
          state.isShuffled = true;
          state.currentIndex = 0;
          
          document.getElementById("shuffleBtn").textContent = "ğŸ”„ å…ƒã®é †åº";
          document.getElementById("shuffleBtn").style.background = "#28a745";
          
          alert(`${state.words.length}å€‹ã®å˜èªã‚’ã‚·ãƒ£ãƒƒãƒ•ãƒ«ã—ã¾ã—ãŸï¼`);
        }

        // è¡¨ç¤ºã‚’æ›´æ–°
        state.showAnswer = false;
        state.selectedOption = null;
        updateDisplay();
        updateWordList();
        saveState();
      }

      // ç¾åœ¨ã®å®Ÿéš›ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’å–å¾—ï¼ˆã‚·ãƒ£ãƒƒãƒ•ãƒ«å¯¾å¿œï¼‰
      function getCurrentWordIndex() {
        if (state.isShuffled && state.shuffledIndices.length > 0) {
          return state.shuffledIndices[state.currentIndex];
        }
        return state.currentIndex;
      }

      // ç¾åœ¨ã®å˜èªã‚’å–å¾—ï¼ˆã‚·ãƒ£ãƒƒãƒ•ãƒ«å¯¾å¿œï¼‰
      function getCurrentWord() {
        const actualIndex = getCurrentWordIndex();
        return state.words[actualIndex];
      }
        if (confirm("å­¦ç¿’é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å…ƒã«æˆ»ã›ã¾ã›ã‚“ã€‚")) {
          state.currentIndex = 0;
          state.correctAnswers = 0;
          state.totalAnswers = 0;
          state.wordResults.clear();
          state.showAnswer = false;
          state.selectedOption = null;
          state.currentFilter = "all";
          state.isShuffled = false;
          state.shuffledIndices = [];

          // ã‚·ãƒ£ãƒƒãƒ•ãƒ«ãƒœã‚¿ãƒ³ã®è¡¨ç¤ºã‚’å…ƒã«æˆ»ã™
          document.getElementById("shuffleBtn").textContent = "ğŸ”€ ã‚·ãƒ£ãƒƒãƒ•ãƒ«";
          document.getElementById("shuffleBtn").style.background = "#6c757d";

          updateDisplay();
          updateStats();
          updateWordList();
          setFilter("all");
          saveState();

          alert("é€²æ—ãŒãƒªã‚»ãƒƒãƒˆã•ã‚Œã¾ã—ãŸã€‚");
        }
      }

      // ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆ
      function switchMode(mode) {
        if (state.isLoading) return;

        state.mode = mode;

        // ãƒœã‚¿ãƒ³ã‚¹ã‚¿ã‚¤ãƒ«æ›´æ–°
        document.getElementById("flashcardMode").className =
          "btn btn-primary" + (mode === "flashcard" ? " active" : "");
        document.getElementById("quizMode").className =
          "btn btn-secondary" + (mode === "quiz" ? " active" : "");

        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„è¡¨ç¤ºåˆ‡ã‚Šæ›¿ãˆ
        document.getElementById("flashcardContent").className =
          mode === "flashcard" ? "" : "hidden";
        document.getElementById("quizContent").className =
          mode === "quiz" ? "" : "hidden";

        updateDisplay();
        saveState();
      }

      // è¡¨ç¤ºæ›´æ–°
      function updateDisplay() {
        if (state.isLoading || state.words.length === 0) return;

        const word = getCurrentWord();
        if (!word) return;

        if (state.mode === "flashcard") {
          document.getElementById("wordDisplay").textContent = word.lemma;
          document.getElementById(
            "wordInfo"
          ).textContent = `SFI Rank: ${word.sfiRank} | Frequency: ${word.frequency}`;
          document.getElementById("meaningDisplay").textContent = word.meaning;
          document.getElementById("exampleDisplay").textContent = word.example;

          document.getElementById("meaningDisplay").className = state.showAnswer
            ? "meaning"
            : "meaning hidden";
          document.getElementById("exampleDisplay").className = state.showAnswer
            ? "example"
            : "example hidden";
        } else {
          document.getElementById("quizWord").textContent = word.lemma;
          document.getElementById(
            "quizInfo"
          ).textContent = `SFI Rank: ${word.sfiRank}`;
          generateQuizOptions(word);
        }

        updateProgress();
      }

      // é€²æ—æ›´æ–°
      function updateProgress() {
        const progress = ((state.currentIndex + 1) / state.words.length) * 100;
        document.getElementById("progressBar").style.width = progress + "%";
      }

      // ç­”ãˆè¡¨ç¤º
      function showAnswer() {
        if (state.isLoading) return;

        state.showAnswer = true;
        document.getElementById("meaningDisplay").className = "meaning";
        document.getElementById("exampleDisplay").className = "example";
      }

      // æ¬¡ã®å˜èª
      function nextWord() {
        if (state.isLoading) return;

        state.currentIndex = (state.currentIndex + 1) % state.words.length;
        state.showAnswer = false;

        const word = getCurrentWord();
        document.getElementById("wordDisplay").textContent = word.lemma;
        document.getElementById(
          "wordInfo"
        ).textContent = `SFI Rank: ${word.sfiRank} | Frequency: ${word.frequency}`;
        document.getElementById("meaningDisplay").textContent = word.meaning;
        document.getElementById("exampleDisplay").textContent = word.example;
        document.getElementById("meaningDisplay").className = "meaning hidden";
        document.getElementById("exampleDisplay").className = "example hidden";

        updateProgress();
        updateWordListItem(getCurrentWordIndex());
        saveState();
      }

      // ã‚¯ã‚¤ã‚ºé¸æŠè‚¢ç”Ÿæˆ
      function generateQuizOptions(correctWord) {
        const options = [correctWord.meaning];
        const usedIndices = new Set([state.currentIndex]);

        while (options.length < 4 && usedIndices.size < state.words.length) {
          const randomIndex = Math.floor(Math.random() * state.words.length);
          if (!usedIndices.has(randomIndex)) {
            usedIndices.add(randomIndex);
            options.push(state.words[randomIndex].meaning);
          }
        }

        for (let i = options.length - 1; i > 0; i--) {
          const j = Math.floor(Math.random() * (i + 1));
          [options[i], options[j]] = [options[j], options[i]];
        }

        const container = document.getElementById("quizOptions");
        const existingButtons = container.querySelectorAll(".quiz-option");

        options.forEach((option, index) => {
          let button = existingButtons[index];
          if (!button) {
            button = document.createElement("button");
            button.className = "quiz-option";
            button.onclick = () => selectOption(index, option);
            container.appendChild(button);
          }
          button.textContent = option;
          button.className = "quiz-option";
          button.onclick = () => selectOption(index, option);
        });

        for (let i = options.length; i < existingButtons.length; i++) {
          existingButtons[i].remove();
        }
      }

      // é¸æŠè‚¢é¸æŠ
      function selectOption(index, option) {
        if (state.isLoading) return;

        document
          .querySelectorAll(".quiz-option")
          .forEach((opt) => opt.classList.remove("selected"));
        document
          .querySelectorAll(".quiz-option")
          [index].classList.add("selected");
        state.selectedOption = option;
      }

      // å›ç­”æå‡º
      function submitAnswer() {
        if (state.isLoading || !state.selectedOption) return;

        const word = getCurrentWord();
        const actualIndex = getCurrentWordIndex();
        const isCorrect = state.selectedOption === word.meaning;

        document.querySelectorAll(".quiz-option").forEach((opt) => {
          if (opt.textContent === word.meaning) {
            opt.classList.add("correct");
          } else if (opt.textContent === state.selectedOption && !isCorrect) {
            opt.classList.add("incorrect");
          }
        });

        state.totalAnswers++;
        if (isCorrect) {
          state.correctAnswers++;
          state.wordResults.set(actualIndex, "correct");
        } else {
          state.wordResults.set(actualIndex, "incorrect");
        }

        updateStats();
        updateWordList();
        saveState();
      }

      // æ¬¡ã®ã‚¯ã‚¤ã‚º
      function nextQuiz() {
        if (state.isLoading) return;

        state.currentIndex = (state.currentIndex + 1) % state.words.length;
        state.selectedOption = null;

        const options = document.querySelectorAll(".quiz-option");
        options.forEach((opt) => (opt.className = "quiz-option"));

        const word = getCurrentWord();
        document.getElementById("quizWord").textContent = word.lemma;
        document.getElementById(
          "quizInfo"
        ).textContent = `SFI Rank: ${word.sfiRank}`;
        generateQuizOptions(word);

        updateProgress();
        updateWordListItem(getCurrentWordIndex());
        saveState();
      }

      // çµ±è¨ˆæ›´æ–°
      function updateStats() {
        document.getElementById("totalWords").textContent = state.words.length;
        document.getElementById("correctAnswers").textContent =
          state.correctAnswers;

        const unsolvedCount = state.words.length - state.wordResults.size;
        document.getElementById("unsolvedCount").textContent = unsolvedCount;

        const accuracy =
          state.totalAnswers > 0
            ? Math.round((state.correctAnswers / state.totalAnswers) * 100)
            : 0;
        document.getElementById("accuracy").textContent = accuracy + "%";
      }

      // å˜èªãƒªã‚¹ãƒˆã®å€‹åˆ¥ã‚¢ã‚¤ãƒ†ãƒ æ›´æ–°
      function updateWordListItem(actualIndex) {
        const items = document.querySelectorAll(".word-item");
        items.forEach((item, i) => {
          if (i === actualIndex) {
            item.classList.add("active");
          } else {
            item.classList.remove("active");
          }
        });
      }

      // å˜èªãƒªã‚¹ãƒˆæ›´æ–°
      function updateWordList() {
        const list = document.getElementById("wordList");
        list.innerHTML = "";

        state.words.forEach((word, index) => {
          const result = state.wordResults.get(index);

          // ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼é©ç”¨
          if (state.currentFilter === "unsolved" && result) return;
          if (state.currentFilter === "correct" && result !== "correct") return;
          if (state.currentFilter === "incorrect" && result !== "incorrect")
            return;

          const item = document.createElement("div");
          item.className = "word-item";

          // çŠ¶æ…‹ã«å¿œã˜ã¦ã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
          if (index === state.currentIndex) item.classList.add("active");
          if (result === "correct") item.classList.add("solved");
          if (result === "incorrect") item.classList.add("incorrect");

          // HTMLæ§‹é€ ã‚’ä½œæˆ
          item.innerHTML = `
                    <div class="word-info-left">
                        <strong>${word.lemma}</strong><br>
                        <small>Rank: ${word.sfiRank}</small>
                    </div>
                    <div class="word-status ${getStatusClass(result)}">
                        ${getStatusText(result)}
                    </div>
                `;

          item.onclick = () => {
            if (state.isLoading) return;
            
            // ã‚·ãƒ£ãƒƒãƒ•ãƒ«æ™‚ã¯å®Ÿéš›ã®ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‹ã‚‰è¡¨ç¤ºã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’é€†ç®—
            if (state.isShuffled) {
              state.currentIndex = state.shuffledIndices.indexOf(index);
            } else {
              state.currentIndex = index;
            }
            
            state.showAnswer = false;
            state.selectedOption = null;
            updateDisplay();
            updateWordListItem(index);
            saveState();
          };

          list.appendChild(item);
        });
      }

      // çŠ¶æ…‹ã«å¿œã˜ãŸã‚¯ãƒ©ã‚¹åã‚’å–å¾—
      function getStatusClass(result) {
        if (!result) return "status-unsolved";
        if (result === "correct") return "status-correct";
        if (result === "incorrect") return "status-incorrect";
        return "status-unsolved";
      }

      // çŠ¶æ…‹ã«å¿œã˜ãŸãƒ†ã‚­ã‚¹ãƒˆã‚’å–å¾—
      function getStatusText(result) {
        if (!result) return "æœªè§£ç­”";
        if (result === "correct") return "æ­£è§£";
        if (result === "incorrect") return "ä¸æ­£è§£";
        return "æœªè§£ç­”";
      }

      // CSVãƒ•ã‚¡ã‚¤ãƒ«å‡¦ç†
      function handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = function (e) {
          const words = parseCSV(e.target.result);
          if (words.length > 0) {
            // æ–°ã—ã„CSVãƒ•ã‚¡ã‚¤ãƒ«ã‚’èª­ã¿è¾¼ã‚€æ™‚ã¯é€²æ—ã‚’ãƒªã‚»ãƒƒãƒˆ
            state.words = words;
            state.currentIndex = 0;
            state.showAnswer = false;
            state.correctAnswers = 0;
            state.totalAnswers = 0;
            state.wordResults.clear();
            state.isLoading = false;
            state.currentFilter = "all";

            updateDisplay();
            updateStats();
            updateWordList();
            setFilter("all");
            saveState();

            alert(words.length + "å€‹ã®å˜èªã‚’èª­ã¿è¾¼ã¿ã¾ã—ãŸï¼");
          }
        };
        reader.readAsText(file);
      }

      // CSVè§£æ
      function parseCSV(csv) {
        const lines = csv.split("\n");
        const words = [];

        for (let i = 1; i < lines.length; i++) {
          const line = lines[i].trim();
          if (!line) continue;

          const cols = line.split(",");
          if (cols.length >= 6) {
            words.push({
              lemma: cols[0].replace(/"/g, ""),
              sfiRank: parseInt(cols[1]) || 0,
              sfi: parseFloat(cols[2]) || 0,
              frequency: parseInt(cols[3]) || 0,
              meaning: cols[4].replace(/"/g, ""),
              example: cols[5].replace(/"/g, ""),
            });
          }
        }

        return words;
      }

      // åˆæœŸåŒ–å®Ÿè¡Œ
      init();
    </script>
  </body>
</html>
